<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เค้กวันเกิด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fce4ec;
            background-image: radial-gradient(circle, #ffebee, #f8bbd0);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 1rem;
        }

        .cake-container {
            position: relative;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            filter: drop-shadow(0 15px 15px rgba(0, 0, 0, 0.15));
        }

        .cake-svg {
            width: 350px;
            height: auto;
            max-width: 90vw;
            transition: transform 0.3s ease-in-out;
        }

        .cake-container:active .cake-svg {
            transform: scale(0.98);
        }

        .candle {
            position: absolute;
            top: 50px; /* Position relative to the cake top */
            transform: translateX(-50%);
            width: 20px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }

        .candle-body {
            width: 12px;
            height: 55px;
            border-radius: 6px;
            position: relative;
            box-shadow: inset 0 -3px 5px rgba(0,0,0,0.1);
        }

        .flame {
            width: 12px;
            height: 25px;
            background: radial-gradient(circle, #ffcc33, #ff9900);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: flicker 0.2s infinite alternate;
            transform-origin: bottom;
            filter: drop-shadow(0 0 8px #ffcc33);
        }

        .flame-extinguished {
            display: none;
        }

        @keyframes flicker {
            0% { transform: scaleY(1); opacity: 1; }
            100% { transform: scaleY(1.1); opacity: 0.8; }
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1.5rem 3rem;
            border-radius: 12px;
            font-size: 1.5rem;
            text-align: center;
            z-index: 100;
            display: none;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        @media (max-width: 768px) {
            .cake-svg {
                width: 300px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="message-box" id="messageBox"></div>

    <div class="container">
        <h1 class="text-4xl md:text-5xl font-bold text-center text-pink-600 mb-6 drop-shadow-lg">สุขสันต์วันเกิด!</h1>
        <p class="text-lg text-gray-700 mb-8 text-center" id="instructions">
            คลิกที่เค้กเพื่อเพิ่มเทียน จากนั้นเป่าเทียน
        </p>

        <div class="cake-container" id="cakeContainer">
            <svg class="cake-svg" viewBox="0 0 350 350" xmlns="http://www.w3.org/2000/svg">
                <!-- Cake base and shadow -->
                <defs>
                    <filter id="dropshadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feOffset result="offOut" in="SourceAlpha" dx="0" dy="10" />
                        <feGaussianBlur result="blurOut" in="offOut" stdDeviation="8" />
                        <feBlend in="SourceGraphic" in2="blurOut" mode="normal" />
                    </filter>
                    <linearGradient id="pinkGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#f06292" />
                        <stop offset="100%" stop-color="#ec407a" />
                    </linearGradient>
                    <linearGradient id="lightPinkGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#f8bbd0" />
                        <stop offset="100%" stop-color="#f48fb1" />
                    </linearGradient>
                </defs>

                <!-- Plate -->
                <ellipse cx="175" cy="305" rx="140" ry="20" fill="#dedede" filter="url(#dropshadow)" />
                <ellipse cx="175" cy="300" rx="140" ry="20" fill="#f0f0f0" />

                <!-- Bottom Cake Layer (Pink) -->
                <path d="M 50 200 C 50 280, 300 280, 300 200 L 300 300 C 300 380, 50 380, 50 300 Z" fill="url(#pinkGradient)" />
                <path d="M 50 200 Q 175 220, 300 200 Z" fill="url(#lightPinkGradient)" />
                
                <!-- Dripping Frosting for Bottom Layer (White) -->
                <path d="M 50 200 C 60 215, 80 210, 95 215 C 110 220, 130 210, 145 215 C 160 220, 180 210, 195 215 C 210 220, 230 210, 245 215 C 260 220, 280 210, 300 200 Z" fill="#fdf0e2" />

                <!-- Top Cake Layer (Light Pink) -->
                <path d="M 70 120 C 70 180, 280 180, 280 120 L 280 200 C 280 260, 70 260, 70 200 Z" fill="url(#lightPinkGradient)" />
                <path d="M 70 120 Q 175 140, 280 120 Z" fill="#fce4ec" />

                <!-- Dripping Frosting for Top Layer (White) -->
                <path d="M 70 120 C 80 135, 100 130, 115 135 C 130 140, 150 130, 165 135 C 180 140, 200 130, 215 135 C 230 140, 250 130, 280 120 Z" fill="#fdf0e2" />
                <ellipse cx="175" cy="120" rx="105" ry="8" fill="#fdf0e2" />

                <!-- Top Frosting (White) -->
                <ellipse cx="175" cy="115" rx="105" ry="8" fill="#fdf0e2" />
            </svg>
        </div>

        <button id="blowButton" class="mt-8 px-8 py-4 bg-pink-500 text-white font-semibold rounded-full shadow-lg hover:bg-pink-600 transition-all transform hover:scale-105 active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
            เป่าเทียน
        </button>
    </div>

    <script>
        const cakeContainer = document.getElementById('cakeContainer');
        const blowButton = document.getElementById('blowButton');
        const messageBox = document.getElementById('messageBox');
        const instructions = document.getElementById('instructions');
        
        let candleCount = 0;
        const maxCandles = 6;
        let isBlowing = false;
        
        let audioContext;
        let analyser;
        let microphone;

        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 2000);
        }

        async function startMicrophone() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const blowThreshold = 150;
                
                function detectSound() {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((sum, value) => sum + value, 0) / bufferLength;

                    if (average > blowThreshold && !isBlowing && candleCount > 0) {
                        blowOutCandles();
                    }
                    requestAnimationFrame(detectSound);
                }
                
                detectSound();
                showMessage("กำลังรอเสียงเป่าจากคุณ...");
                instructions.textContent = "คลิกที่เค้กเพื่อเพิ่มเทียน จากนั้นเป่าเทียน";
                blowButton.style.display = 'none';
            } catch (err) {
                console.error('Error accessing microphone: ', err);
                showMessage("ไม่สามารถเข้าถึงไมโครโฟนได้ กรุณาอนุญาตเพื่อเป่าเทียน");
                blowButton.style.display = 'block';
                blowButton.textContent = 'เป่าเทียน';
            }
        }
        
        function blowOutCandles() {
            if (candleCount === 0) {
                showMessage("ยังไม่มีเทียน!");
                return;
            }

            isBlowing = true;
            blowButton.disabled = true;

            const candles = document.querySelectorAll('.candle');
            candles.forEach((candle, index) => {
                setTimeout(() => {
                    const flame = candle.querySelector('.flame');
                    if (flame) {
                        flame.classList.add('flame-extinguished');
                    }
                }, index * 300);
            });

            setTimeout(() => {
                showMessage("สุขสันต์วันเกิด! 🎂");
                isBlowing = false;
                candleCount = 0;
                candles.forEach(candle => candle.remove());
                blowButton.disabled = true;
            }, candles.length * 300 + 1000);
        }

        cakeContainer.addEventListener('click', (e) => {
            if (isBlowing) {
                showMessage("กำลังเป่าเทียน... กรุณารอสักครู่");
                return;
            }

            if (candleCount >= maxCandles) {
                showMessage("เทียนเต็มแล้ว!");
                return;
            }
            
            const cakeRect = cakeContainer.getBoundingClientRect();
            const cakeX = e.clientX - cakeRect.left;
            const cakeWidth = cakeRect.width;

            const baseWidth = 350;
            const scaleX = cakeWidth / baseWidth;

            const candleOffset = (cakeX - cakeWidth / 2) / scaleX;

            const newCandle = document.createElement('div');
            newCandle.classList.add('candle');
            newCandle.style.left = `calc(50% + ${candleOffset}px)`;

            const colors = ['#f59e0b', '#f97316', '#ef4444', '#f472b6', '#a855f7', '#3b82f6'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];

            newCandle.innerHTML = `
                <div class="flame"></div>
                <div class="candle-body" style="background-color: ${randomColor};"></div>
            `;
            
            cakeContainer.appendChild(newCandle);
            candleCount++;

            if (candleCount > 0) {
                blowButton.disabled = false;
            }
        });

        blowButton.addEventListener('click', blowOutCandles);
        
        window.onload = startMicrophone;
    </script>
</body>
</html>
